#!/usr/bin/env bash

# 
#        ██╗██████╗        ██████╗██╗  ██╗ ██████╗     
#        ██║██╔══██╗      ██╔════╝██║  ██║██╔═══██╗    
#        ██║██████╔╝█████╗██║     ███████║██║   ██║    
#   ██   ██║██╔══██╗╚════╝██║     ██╔══██║██║   ██║    
#   ╚█████╔╝██║  ██║      ╚██████╗██║  ██║╚██████╔╝    
#    ╚════╝ ╚═╝  ╚═╝       ╚═════╝╚═╝  ╚═╝ ╚═════╝     
#  

set -o pipefail

# Color output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Metadata
readonly CMAN_VERSION="0.2.0"
readonly CMAN_HOME="${CMAN_HOME:-.cman}"

################################################################################
# Utility Functions
################################################################################

log_info() {
    echo -e "${BLUE}[INFO]${NC} $*" >&2
}

log_success() {
    echo -e "${GREEN}[✓]${NC} $*" >&2
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*" >&2
}

log_error() {
    echo -e "${RED}[✗]${NC} $*" >&2
}

die() {
    log_error "$@"
    exit 1
}

command_exists() {
    command -v "$1" &> /dev/null
}

detect_os() {
    case "$(uname -s)" in
        Linux*)   echo "linux" ;;
        Darwin*)  echo "macos" ;;
        *)        echo "unknown" ;;
    esac
}

detect_compiler() {
    if command_exists clang; then
        echo "clang"
    elif command_exists gcc; then
        echo "gcc"
    else
        die "No C compiler found. Please install clang or gcc."
    fi
}

validate_project_dir() {
    if [[ ! -f "cman.toml" ]]; then
        die "cman.toml not found. Are you in a cman project directory?"
    fi
}

print_banner() {
    echo -e "${BLUE}"
    cat << "EOF"
        ██████╗███╗   ███╗ █████╗ ███╗   ██╗
       ██╔════╝████╗ ████║██╔══██╗████╗  ██║
       ██║     ██╔████╔██║███████║██╔██╗ ██║
       ██║     ██║╚██╔╝██║██╔══██║██║╚██╗██║
       ╚██████╗██║ ╚═╝ ██║██║  ██║██║ ╚████║
        ╚═════╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝
EOF
    echo -e "${NC}"
    echo -e "${BLUE}        cman v$CMAN_VERSION${NC}"
    echo -e "${BLUE}        C Project Manager${NC}"
    echo ""
}

################################################################################
# Configuration Management
################################################################################

load_config() {
    local config_file="${1:-.}/cman.toml"

    if [[ ! -f "$config_file" ]]; then
        return 1
    fi

    while IFS='=' read -r key value; do
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs | sed 's/"//g')
        [[ -z "$key" || "$key" =~ ^# ]] && continue
        export "CONFIG_${key^^}"="$value"
    done < <(sed 's/ //g' "$config_file" | grep -E '^[a-z_]+=' || true)
}

config_get() {
    local key="$1"
    local default="${2:-}"
    local var_name="CONFIG_${key^^}"
    echo "${!var_name:-$default}"
}

################################################################################
# Subcommand: new
################################################################################

cmd_new() {
    local project_name="${1:-}"
    local project_type="default"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --test)     project_type="test" ;;
            --clean)    project_type="clean" ;;
            --embedded) project_type="embedded" ;;
            *)
                if [[ -z "$project_name" ]]; then
                    project_name="$1"
                fi
                ;;
        esac
        shift
    done

    [[ -z "$project_name" ]] && die "Usage: cman new <project_name> [--test | --clean | --embedded]"
    [[ -d "$project_name" ]] && die "Directory '$project_name' already exists"

    log_info "Creating new $project_type project: $project_name"

    mkdir -p "$project_name"/{include,src,build,bin,tests}

    cat > "$project_name/cman.toml" << EOF
[project]
name = "$project_name"
version = "0.1.0"
type = "$project_type"

[build]
compiler = "$(detect_compiler)"
src = "src"
include = "include"
build = "build"
bin = "bin"
cflags = "-Wall -Wextra -std=c11"
ldflags = ""

[dev]
debug = true
optimization = "0"

[release]
debug = false
optimization = "3"
EOF

    cat > "$project_name/README.md" << EOF
# $project_name

A C project managed with cman.

## Build

\`\`\`bash
cman build
\`\`\`

## Run

\`\`\`bash
cman run
\`\`\`

## Test

\`\`\`bash
cman test
\`\`\`
EOF

    cat > "$project_name/Makefile" << 'EOF'
# This Makefile is auto-generated. Use 'cman' commands instead.
.PHONY: all build run test clean

all: build

build:
	cman build

run: build
	cman run

test:
	cman test

clean:
	cman clean
EOF

    cat > "$project_name/.gitignore" << 'EOF'
/build/
/bin/
*.o
*.a
*.so
.cman/
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store
EOF

    cat > "$project_name/src/main.c" << 'EOF'
#include <stdio.h>

int main(void) {
    printf("Hello from cman!\n");
    return 0;
}
EOF

    cat > "$project_name/include/hello.h" << 'EOF'
#ifndef HELLO_H
#define HELLO_H

void hello(void);

#endif // HELLO_H
EOF

    if [[ "$project_type" == "test" ]]; then
        cat > "$project_name/tests/test_main.c" << 'EOF'
#include <stdio.h>

int main(void) {
    printf("Running tests...\n");
    return 0;
}
EOF
    fi

    log_success "Project created at: $project_name"
    log_info "Next steps:"
    echo "  1. cd $project_name"
    echo "  2. cman build"
    echo "  3. cman run"
}

################################################################################
# Subcommand: init
################################################################################

cmd_init() {
    local project_type="default"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --test)     project_type="test" ;;
            --clean)    project_type="clean" ;;
            --embedded) project_type="embedded" ;;
            *)          ;;
        esac
        shift
    done

    [[ -f "cman.toml" ]] && die "cman.toml already exists in this directory"

    local project_name="${PWD##*/}"

    log_info "Initializing cman project: $project_name"

    mkdir -p {include,src,build,bin,tests}

    cat > cman.toml << EOF
[project]
name = "$project_name"
version = "0.1.0"
type = "$project_type"

[build]
compiler = "$(detect_compiler)"
src = "src"
include = "include"
build = "build"
bin = "bin"
cflags = "-Wall -Wextra -std=c11"
ldflags = ""

[dev]
debug = true
optimization = "0"

[release]
debug = false
optimization = "3"
EOF

    if [[ ! -f ".gitignore" ]]; then
        cat > .gitignore << 'EOF'
/build/
/bin/
*.o
*.a
*.so
.cman/
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store
EOF
    fi

    if [[ ! -f "README.md" ]]; then
        cat > README.md << EOF
# $project_name

A C project managed with cman.
EOF
    fi

    log_success "Project initialized: $project_name"
}

################################################################################
# Subcommand: build
################################################################################

cmd_build() {
    local release=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --release) release=true ;;
            *)         ;;
        esac
        shift
    done

    validate_project_dir
    load_config

    local compiler=$(config_get "build_compiler" "clang")
    local src_dir=$(config_get "build_src" "src")
    local include_dir=$(config_get "build_include" "include")
    local build_dir=$(config_get "build_build" "build")
    local bin_dir=$(config_get "build_bin" "bin")
    local cflags=$(config_get "build_cflags" "-Wall -Wextra -std=c11")
    local project_name=$(config_get "project_name" "main")

    local opt_level="-O0"
    if [[ "$release" == "true" ]]; then
        opt_level="-O3"
        log_info "Building in RELEASE mode"
    else
        log_info "Building in DEBUG mode"
    fi

    command_exists "$compiler" || die "Compiler '$compiler' not found. Please install it or update cman.toml"

    mkdir -p "$build_dir" "$bin_dir"

    local sources=()
    while IFS= read -r -d '' file; do
        sources+=("$file")
    done < <(find "$src_dir" -name "*.c" -print0 2>/dev/null) || true

    [[ ${#sources[@]} -eq 0 ]] && die "No source files found in $src_dir"

    log_info "Compiling with $compiler..."

    for source in "${sources[@]}"; do
        local obj_file="$build_dir/$(basename "${source%.c}").o"
        log_info "Compiling: $source → $obj_file"

        if ! $compiler $opt_level $cflags -I"$include_dir" -c "$source" -o "$obj_file"; then
            die "Compilation failed for $source"
        fi
    done

    local binary="$bin_dir/$project_name"
    log_info "Linking: $binary"

    local obj_files=()
    while IFS= read -r -d '' file; do
        obj_files+=("$file")
    done < <(find "$build_dir" -name "*.o" -print0 2>/dev/null) || true

    if ! $compiler "${obj_files[@]}" -o "$binary"; then
        die "Linking failed"
    fi

    log_success "Build complete: $binary"
}

################################################################################
# Subcommand: run
################################################################################

cmd_run() {
    local version="${1:-main}"

    validate_project_dir
    load_config

    local bin_dir=$(config_get "build_bin" "bin")
    local binary="$bin_dir/$version"

    if [[ ! -f "$binary" ]]; then
        log_info "Binary not found. Building..."
        cmd_build
    fi

    log_info "Running: $binary"
    "$binary" "$@"
}

################################################################################
# Subcommand: test
################################################################################

cmd_test() {
    validate_project_dir
    load_config

    local src_dir=$(config_get "build_src" "src")
    local include_dir=$(config_get "build_include" "include")
    local build_dir=$(config_get "build_build" "build")
    local bin_dir=$(config_get "build_bin" "bin")
    local compiler=$(config_get "build_compiler" "clang")
    local cflags=$(config_get "build_cflags" "-Wall -Wextra -std=c11")

    local test_dir="tests"
    local test_bin="$bin_dir/test_runner"

    [[ ! -d "$test_dir" ]] && die "No tests/ directory found"

    local test_sources=()
    while IFS= read -r -d '' file; do
        test_sources+=("$file")
    done < <(find "$test_dir" -name "test_*.c" -print0 2>/dev/null) || true

    if [[ ${#test_sources[@]} -eq 0 ]]; then
        log_warn "No test files found in $test_dir"
        return 0
    fi

    log_info "Compiling tests..."
    mkdir -p "$build_dir" "$bin_dir"

    for test_src in "${test_sources[@]}"; do
        local obj_file="$build_dir/$(basename "${test_src%.c}").o"
        log_info "Compiling: $test_src"

        if ! $compiler -g -O0 $cflags -I"$include_dir" -c "$test_src" -o "$obj_file"; then
            die "Test compilation failed for $test_src"
        fi
    done

    log_info "Linking test executable..."

    local obj_files=()
    while IFS= read -r -d '' file; do
        obj_files+=("$file")
    done < <(find "$build_dir" -name "test_*.o" -print0 2>/dev/null) || true

    if ! $compiler "${obj_files[@]}" -o "$test_bin"; then
        die "Test linking failed"
    fi

    log_success "Running tests..."
    "$test_bin"
}

################################################################################
# Subcommand: clean
################################################################################

cmd_clean() {
    validate_project_dir
    load_config

    local build_dir=$(config_get "build_build" "build")
    local bin_dir=$(config_get "build_bin" "bin")

    log_info "Cleaning build artifacts..."
    rm -rf "$build_dir" "$bin_dir"
    log_success "Clean complete"
}

################################################################################
# Subcommand: format
################################################################################

cmd_format() {
    validate_project_dir

    command_exists clang-format || die "clang-format not found. Please install it."

    log_info "Formatting code..."

    local formatted_count=0

    for file in $(find . -name "*.c" -o -name "*.h"); do
        log_info "Formatting: $file"
        clang-format -i "$file"
        ((formatted_count++))
    done

    log_success "Formatted $formatted_count files"
}

################################################################################
# Subcommand: check
################################################################################

cmd_check() {
    validate_project_dir
    load_config

    command_exists clang-tidy || die "clang-tidy not found. Please install it."

    local include_dir=$(config_get "build_include" "include")

    log_info "Running static analysis..."
    clang-tidy -checks='*' src/*.c -- -I"$include_dir" 2>/dev/null || true
    log_success "Static analysis complete"
}

################################################################################
# Subcommand: config
################################################################################

cmd_config() {
    local action="${1:-view}"
    local key="${2:-}"
    local value="${3:-}"

    validate_project_dir

    case "$action" in
        view)
            log_info "Current configuration:"
            cat cman.toml
            ;;
        set)
            [[ -z "$key" || -z "$value" ]] && die "Usage: cman config set <key> <value>"
            log_info "Setting $key = $value"

            if grep -q "^$key =" cman.toml; then
                sed -i.bak "s/^$key =.*/$key = $value/" cman.toml
                rm -f cman.toml.bak
            else
                echo "$key = $value" >> cman.toml
            fi

            log_success "Configuration updated"
            ;;
        get)
            [[ -z "$key" ]] && die "Usage: cman config get <key>"
            load_config
            local var_name="CONFIG_${key^^}"
            echo "${!var_name:-not set}"
            ;;
        *)
            die "Unknown config action: $action (view|set|get)"
            ;;
    esac
}

################################################################################
# Subcommand: env
################################################################################

cmd_env() {
    log_info "cman Environment:"
    echo "  OS: $(detect_os)"
    echo "  Available Compiler: $(detect_compiler)"
    echo "  cman Version: $CMAN_VERSION"

    if [[ -f "cman.toml" ]]; then
        load_config
        echo ""
        log_info "Project Configuration:"
        echo "  Project Name: $(config_get 'project_name')"
        echo "  Project Version: $(config_get 'project_version')"
        echo "  Project Type: $(config_get 'project_type')"
        echo "  Compiler: $(config_get 'build_compiler')"
        echo "  CFLAGS: $(config_get 'build_cflags')"
    fi
}

################################################################################
# Placeholder Subcommands
################################################################################

cmd_package() {
    log_warn "Command 'package' not yet implemented"
    log_info "Planned: Bundle project for distribution"
}

cmd_install() {
    log_warn "Command 'install' not yet implemented"
    log_info "Planned: Install binary system-wide"
}

cmd_update() {
    log_warn "Command 'update' not yet implemented"
    log_info "Planned: Update dependencies"
}

cmd_embed() {
    log_warn "Command 'embed' not yet implemented"
    log_info "Planned: Cross-compilation for embedded targets"
}

cmd_bench() {
    log_warn "Command 'bench' not yet implemented"
    log_info "Planned: Performance benchmarking"
}

################################################################################
# Help and Man Pages
################################################################################

cmd_help() {
    print_banner
    cat << 'EOF'
USAGE:
    cman <COMMAND> [OPTIONS]

COMMANDS:
    new <n>          Create a new C project
    init                Initialize current directory as a C project
    build               Compile the project
    run                 Run the compiled executable
    test                Compile and run tests
    clean               Remove build artifacts
    format              Format code with clang-format
    check               Run static analysis
    config              View or modify configuration
    env                 Print environment information
    help                Show this message
    man                 Open detailed manual
    version             Show version

Run 'cman man' for detailed documentation.
EOF
}

cmd_man() {
    local tmp_man
    tmp_man=$(mktemp)
    
    cat > "$tmp_man" << 'MANEOF'
cman(1)                     C Project Manager                      CMAN(1)

NAME
    cman - A Cargo-style C project manager and build orchestrator

SYNOPSIS
    cman [COMMAND] [OPTIONS]

DESCRIPTION
    cman is a modern command-line build orchestrator for C projects, inspired
    by Cargo. It provides a unified interface for creating, building, testing,
    and managing C projects with sensible defaults and minimal configuration.

COMMANDS
    new [--test | --clean | --embedded] <n>
        Create a new C project with the specified name. Optional flags control
        the project template type.

    init [--test | --clean | --embedded]
        Initialize the current directory as a cman project. Useful for
        converting existing projects.

    build [--release]
        Compile the project. By default, builds in debug mode (-O0). Use
        --release for optimized builds (-O3).

    run [version]
        Run the compiled executable. Defaults to the project binary. If the
        binary doesn't exist, automatically builds it.

    test
        Discover and compile all test_*.c files in the tests/ directory,
        then execute the test runner.

    clean
        Remove all build artifacts (build/ and bin/ directories).

    format
        Run clang-format on all .c and .h files in the project.

    check
        Run clang-tidy static analysis on source files.

    config [view|set|get] [key] [value]
        View, set, or get configuration values from cman.toml.
        - config view      Display entire configuration
        - config set KEY VALUE
        - config get KEY   Print a specific value

    env
        Print environment information including detected compiler, OS,
        and current project configuration.

    package
        Bundle project for distribution (future).

    install
        Install built binary system-wide (future).

    update
        Update project dependencies (future).

    embed
        Cross-compile for embedded targets (future).

    bench
        Run performance benchmarks (future).

    version, -v, --version
        Print cman version.

    help, -h, --help
        Print brief usage information.

    man
        Display this manual page.

PROJECT STRUCTURE
    When you create or initialize a project, cman generates:

        project_name/
        ├── include/           Header files (.h)
        ├── src/               Source files (.c)
        ├── build/             Object files (.o) [generated]
        ├── bin/               Executables [generated]
        ├── tests/             Unit tests
        ├── cman.toml          Project configuration
        ├── Makefile           Build information
        ├── README.md          Documentation
        └── .gitignore         Git ignore rules

CONFIGURATION
    Projects are configured via cman.toml in TOML format:

        [project]
        name = "myapp"
        version = "0.1.0"
        type = "default"

        [build]
        compiler = "clang"
        src = "src"
        include = "include"
        build = "build"
        bin = "bin"
        cflags = "-Wall -Wextra -std=c11"
        ldflags = ""

        [dev]
        debug = true
        optimization = "0"

        [release]
        debug = false
        optimization = "3"

EXAMPLES
    Create a new project:
        $ cman new my_app
        $ cd my_app
        $ cman build
        $ cman run

    Create a test project:
        $ cman new --test my_tests

    Initialize existing directory:
        $ cd existing_project
        $ cman init

    Build in release mode:
        $ cman build --release

    Run tests:
        $ cman test

    Configure compiler:
        $ cman config set build_compiler gcc

ENVIRONMENT
    CMAN_HOME     Directory for cman metadata (default: .cman)
    PAGER         Pager for manual pages (default: less)

SUPPORT
    Bug reports and feature requests:
        https://github.com/jr-cho/cman/issues

    Documentation:
        https://github.com/jr-cho/cman

AUTHOR
    Maintained by jr-cho

VERSION
    cman 0.2.0

CMAN(1)                     C Project Manager                      CMAN(1)
MANEOF

    man "$tmp_man" 2>/dev/null || ${PAGER:-less} "$tmp_man"
    rm -f "$tmp_man"
}

cmd_version() {
    echo "cman $CMAN_VERSION"
}

################################################################################
# Main Command Dispatcher
################################################################################

main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        new)        cmd_new "$@" ;;
        init)       cmd_init "$@" ;;
        build)      cmd_build "$@" ;;
        run)        cmd_run "$@" ;;
        test)       cmd_test "$@" ;;
        clean)      cmd_clean "$@" ;;
        format)     cmd_format "$@" ;;
        check)      cmd_check "$@" ;;
        config)     cmd_config "$@" ;;
        env)        cmd_env "$@" ;;
        package)    cmd_package "$@" ;;
        install)    cmd_install "$@" ;;
        update)     cmd_update "$@" ;;
        embed)      cmd_embed "$@" ;;
        bench)      cmd_bench "$@" ;;
        help|-h|--help)
                    cmd_help ;;
        man)        cmd_man ;;
        version|-v|--version)
                    cmd_version ;;
        *)
            log_error "Unknown command: $command"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"

################################################################################
# cman - C Project Manager (Cargo-style for C)
# A modern command-line build orchestrator and project manager for C projects
################################################################################

set -o pipefail

# Color output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Metadata
readonly CMAN_VERSION="0.2.0"
readonly CMAN_HOME="${CMAN_HOME:-.cman}"

################################################################################
# Utility Functions
################################################################################

log_info() {
    echo -e "${BLUE}[INFO]${NC} $*" >&2
}

log_success() {
    echo -e "${GREEN}[✓]${NC} $*" >&2
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*" >&2
}

log_error() {
    echo -e "${RED}[✗]${NC} $*" >&2
}

die() {
    log_error "$@"
    exit 1
}

command_exists() {
    command -v "$1" &> /dev/null
}

detect_os() {
    case "$(uname -s)" in
        Linux*)   echo "linux" ;;
        Darwin*)  echo "macos" ;;
        *)        echo "unknown" ;;
    esac
}

detect_compiler() {
    if command_exists clang; then
        echo "clang"
    elif command_exists gcc; then
        echo "gcc"
    else
        die "No C compiler found. Please install clang or gcc."
    fi
}

validate_project_dir() {
    if [[ ! -f "cman.toml" ]]; then
        die "cman.toml not found. Are you in a cman project directory?"
    fi
}

print_banner() {
    echo -e "${BLUE}"
    cat << "EOF"
        ██████╗███╗   ███╗ █████╗ ███╗   ██╗
       ██╔════╝████╗ ████║██╔══██╗████╗  ██║
       ██║     ██╔████╔██║███████║██╔██╗ ██║
       ██║     ██║╚██╔╝██║██╔══██║██║╚██╗██║
       ╚██████╗██║ ╚═╝ ██║██║  ██║██║ ╚████║
        ╚═════╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝
EOF
    echo -e "${NC}"
    echo -e "${BLUE}        cman v$CMAN_VERSION${NC}"
    echo -e "${BLUE}        C Project Manager${NC}"
    echo ""
}

################################################################################
# Configuration Management
################################################################################

load_config() {
    local config_file="${1:-.}/cman.toml"

    if [[ ! -f "$config_file" ]]; then
        return 1
    fi

    while IFS='=' read -r key value; do
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs | sed 's/"//g')
        [[ -z "$key" || "$key" =~ ^# ]] && continue
        export "CONFIG_${key^^}"="$value"
    done < <(sed 's/ //g' "$config_file" | grep -E '^[a-z_]+=' || true)
}

config_get() {
    local key="$1"
    local default="${2:-}"
    local var_name="CONFIG_${key^^}"
    echo "${!var_name:-$default}"
}

################################################################################
# Subcommand: new
################################################################################

cmd_new() {
    local project_name="${1:-}"
    local project_type="default"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --test)     project_type="test" ;;
            --clean)    project_type="clean" ;;
            --embedded) project_type="embedded" ;;
            *)
                if [[ -z "$project_name" ]]; then
                    project_name="$1"
                fi
                ;;
        esac
        shift
    done

    [[ -z "$project_name" ]] && die "Usage: cman new <project_name> [--test | --clean | --embedded]"
    [[ -d "$project_name" ]] && die "Directory '$project_name' already exists"

    log_info "Creating new $project_type project: $project_name"

    mkdir -p "$project_name"/{include,src,build,bin,tests}

    cat > "$project_name/cman.toml" << EOF
[project]
name = "$project_name"
version = "0.1.0"
type = "$project_type"

[build]
compiler = "$(detect_compiler)"
src = "src"
include = "include"
build = "build"
bin = "bin"
cflags = "-Wall -Wextra -std=c11"
ldflags = ""

[dev]
debug = true
optimization = "0"

[release]
debug = false
optimization = "3"
EOF

    cat > "$project_name/README.md" << EOF
# $project_name

A C project managed with cman.

## Build

\`\`\`bash
cman build
\`\`\`

## Run

\`\`\`bash
cman run
\`\`\`

## Test

\`\`\`bash
cman test
\`\`\`
EOF

    cat > "$project_name/Makefile" << 'EOF'
# This Makefile is auto-generated. Use 'cman' commands instead.
.PHONY: all build run test clean

all: build

build:
	cman build

run: build
	cman run

test:
	cman test

clean:
	cman clean
EOF

    cat > "$project_name/.gitignore" << 'EOF'
/build/
/bin/
*.o
*.a
*.so
.cman/
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store
EOF

    cat > "$project_name/src/main.c" << 'EOF'
#include <stdio.h>

int main(void) {
    printf("Hello from cman!\n");
    return 0;
}
EOF

    cat > "$project_name/include/hello.h" << 'EOF'
#ifndef HELLO_H
#define HELLO_H

void hello(void);

#endif // HELLO_H
EOF

    if [[ "$project_type" == "test" ]]; then
        cat > "$project_name/tests/test_main.c" << 'EOF'
#include <stdio.h>

int main(void) {
    printf("Running tests...\n");
    return 0;
}
EOF
    fi

    log_success "Project created at: $project_name"
    log_info "Next steps:"
    echo "  1. cd $project_name"
    echo "  2. cman build"
    echo "  3. cman run"
}

################################################################################
# Subcommand: init
################################################################################

cmd_init() {
    local project_type="default"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --test)     project_type="test" ;;
            --clean)    project_type="clean" ;;
            --embedded) project_type="embedded" ;;
            *)          ;;
        esac
        shift
    done

    [[ -f "cman.toml" ]] && die "cman.toml already exists in this directory"

    local project_name="${PWD##*/}"

    log_info "Initializing cman project: $project_name"

    mkdir -p {include,src,build,bin,tests}

    cat > cman.toml << EOF
[project]
name = "$project_name"
version = "0.1.0"
type = "$project_type"

[build]
compiler = "$(detect_compiler)"
src = "src"
include = "include"
build = "build"
bin = "bin"
cflags = "-Wall -Wextra -std=c11"
ldflags = ""

[dev]
debug = true
optimization = "0"

[release]
debug = false
optimization = "3"
EOF

    if [[ ! -f ".gitignore" ]]; then
        cat > .gitignore << 'EOF'
/build/
/bin/
*.o
*.a
*.so
.cman/
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store
EOF
    fi

    if [[ ! -f "README.md" ]]; then
        cat > README.md << EOF
# $project_name

A C project managed with cman.
EOF
    fi

    log_success "Project initialized: $project_name"
}

################################################################################
# Subcommand: build
################################################################################

cmd_build() {
    local release=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --release) release=true ;;
            *)         ;;
        esac
        shift
    done

    validate_project_dir
    load_config

    local compiler=$(config_get "build_compiler" "clang")
    local src_dir=$(config_get "build_src" "src")
    local include_dir=$(config_get "build_include" "include")
    local build_dir=$(config_get "build_build" "build")
    local bin_dir=$(config_get "build_bin" "bin")
    local cflags=$(config_get "build_cflags" "-Wall -Wextra -std=c11")
    local project_name=$(config_get "project_name" "main")

    local opt_level="-O0"
    if [[ "$release" == "true" ]]; then
        opt_level="-O3"
        log_info "Building in RELEASE mode"
    else
        log_info "Building in DEBUG mode"
    fi

    command_exists "$compiler" || die "Compiler '$compiler' not found. Please install it or update cman.toml"

    mkdir -p "$build_dir" "$bin_dir"

    local sources=()
    while IFS= read -r -d '' file; do
        sources+=("$file")
    done < <(find "$src_dir" -name "*.c" -print0 2>/dev/null) || true

    [[ ${#sources[@]} -eq 0 ]] && die "No source files found in $src_dir"

    log_info "Compiling with $compiler..."

    for source in "${sources[@]}"; do
        local obj_file="$build_dir/$(basename "${source%.c}").o"
        log_info "Compiling: $source → $obj_file"

        if ! $compiler $opt_level $cflags -I"$include_dir" -c "$source" -o "$obj_file"; then
            die "Compilation failed for $source"
        fi
    done

    local binary="$bin_dir/$project_name"
    log_info "Linking: $binary"

    local obj_files=()
    while IFS= read -r -d '' file; do
        obj_files+=("$file")
    done < <(find "$build_dir" -name "*.o" -print0 2>/dev/null) || true

    if ! $compiler "${obj_files[@]}" -o "$binary"; then
        die "Linking failed"
    fi

    log_success "Build complete: $binary"
}

################################################################################
# Subcommand: run
################################################################################

cmd_run() {
    local version="${1:-main}"

    validate_project_dir
    load_config

    local bin_dir=$(config_get "build_bin" "bin")
    local binary="$bin_dir/$version"

    if [[ ! -f "$binary" ]]; then
        log_info "Binary not found. Building..."
        cmd_build
    fi

    log_info "Running: $binary"
    "$binary" "$@"
}

################################################################################
# Subcommand: test
################################################################################

cmd_test() {
    validate_project_dir
    load_config

    local src_dir=$(config_get "build_src" "src")
    local include_dir=$(config_get "build_include" "include")
    local build_dir=$(config_get "build_build" "build")
    local bin_dir=$(config_get "build_bin" "bin")
    local compiler=$(config_get "build_compiler" "clang")
    local cflags=$(config_get "build_cflags" "-Wall -Wextra -std=c11")

    local test_dir="tests"
    local test_bin="$bin_dir/test_runner"

    [[ ! -d "$test_dir" ]] && die "No tests/ directory found"

    local test_sources=()
    while IFS= read -r -d '' file; do
        test_sources+=("$file")
    done < <(find "$test_dir" -name "test_*.c" -print0 2>/dev/null) || true

    if [[ ${#test_sources[@]} -eq 0 ]]; then
        log_warn "No test files found in $test_dir"
        return 0
    fi

    log_info "Compiling tests..."
    mkdir -p "$build_dir" "$bin_dir"

    for test_src in "${test_sources[@]}"; do
        local obj_file="$build_dir/$(basename "${test_src%.c}").o"
        log_info "Compiling: $test_src"

        if ! $compiler -g -O0 $cflags -I"$include_dir" -c "$test_src" -o "$obj_file"; then
            die "Test compilation failed for $test_src"
        fi
    done

    log_info "Linking test executable..."

    local obj_files=()
    while IFS= read -r -d '' file; do
        obj_files+=("$file")
    done < <(find "$build_dir" -name "test_*.o" -print0 2>/dev/null) || true

    if ! $compiler "${obj_files[@]}" -o "$test_bin"; then
        die "Test linking failed"
    fi

    log_success "Running tests..."
    "$test_bin"
}

################################################################################
# Subcommand: clean
################################################################################

cmd_clean() {
    validate_project_dir
    load_config

    local build_dir=$(config_get "build_build" "build")
    local bin_dir=$(config_get "build_bin" "bin")

    log_info "Cleaning build artifacts..."
    rm -rf "$build_dir" "$bin_dir"
    log_success "Clean complete"
}

################################################################################
# Subcommand: format
################################################################################

cmd_format() {
    validate_project_dir

    command_exists clang-format || die "clang-format not found. Please install it."

    log_info "Formatting code..."

    local formatted_count=0

    for file in $(find . -name "*.c" -o -name "*.h"); do
        log_info "Formatting: $file"
        clang-format -i "$file"
        ((formatted_count++))
    done

    log_success "Formatted $formatted_count files"
}

################################################################################
# Subcommand: check
################################################################################

cmd_check() {
    validate_project_dir
    load_config

    command_exists clang-tidy || die "clang-tidy not found. Please install it."

    local include_dir=$(config_get "build_include" "include")

    log_info "Running static analysis..."
    clang-tidy -checks='*' src/*.c -- -I"$include_dir" 2>/dev/null || true
    log_success "Static analysis complete"
}

################################################################################
# Subcommand: config
################################################################################

cmd_config() {
    local action="${1:-view}"
    local key="${2:-}"
    local value="${3:-}"

    validate_project_dir

    case "$action" in
        view)
            log_info "Current configuration:"
            cat cman.toml
            ;;
        set)
            [[ -z "$key" || -z "$value" ]] && die "Usage: cman config set <key> <value>"
            log_info "Setting $key = $value"

            if grep -q "^$key =" cman.toml; then
                sed -i.bak "s/^$key =.*/$key = $value/" cman.toml
                rm -f cman.toml.bak
            else
                echo "$key = $value" >> cman.toml
            fi

            log_success "Configuration updated"
            ;;
        get)
            [[ -z "$key" ]] && die "Usage: cman config get <key>"
            load_config
            local var_name="CONFIG_${key^^}"
            echo "${!var_name:-not set}"
            ;;
        *)
            die "Unknown config action: $action (view|set|get)"
            ;;
    esac
}

################################################################################
# Subcommand: env
################################################################################

cmd_env() {
    log_info "cman Environment:"
    echo "  OS: $(detect_os)"
    echo "  Available Compiler: $(detect_compiler)"
    echo "  cman Version: $CMAN_VERSION"

    if [[ -f "cman.toml" ]]; then
        load_config
        echo ""
        log_info "Project Configuration:"
        echo "  Project Name: $(config_get 'project_name')"
        echo "  Project Version: $(config_get 'project_version')"
        echo "  Project Type: $(config_get 'project_type')"
        echo "  Compiler: $(config_get 'build_compiler')"
        echo "  CFLAGS: $(config_get 'build_cflags')"
    fi
}

################################################################################
# Placeholder Subcommands
################################################################################

cmd_package() {
    log_warn "Command 'package' not yet implemented"
    log_info "Planned: Bundle project for distribution"
}

cmd_install() {
    log_warn "Command 'install' not yet implemented"
    log_info "Planned: Install binary system-wide"
}

cmd_update() {
    log_warn "Command 'update' not yet implemented"
    log_info "Planned: Update dependencies"
}

cmd_embed() {
    log_warn "Command 'embed' not yet implemented"
    log_info "Planned: Cross-compilation for embedded targets"
}

cmd_bench() {
    log_warn "Command 'bench' not yet implemented"
    log_info "Planned: Performance benchmarking"
}

################################################################################
# Help and Man Pages
################################################################################

cmd_help() {
    print_banner
    cat << 'EOF'
USAGE:
    cman <COMMAND> [OPTIONS]

COMMANDS:
    new <n>          Create a new C project
    init                Initialize current directory as a C project
    build               Compile the project
    run                 Run the compiled executable
    test                Compile and run tests
    clean               Remove build artifacts
    format              Format code with clang-format
    check               Run static analysis
    config              View or modify configuration
    env                 Print environment information
    help                Show this message
    man                 Open detailed manual
    version             Show version

Run 'cman man' for detailed documentation.
EOF
}

cmd_man() {
    local tmp_man
    tmp_man=$(mktemp)
    
    cat > "$tmp_man" << 'MANEOF'
cman(1)                     C Project Manager                      CMAN(1)

NAME
    cman - A Cargo-style C project manager and build orchestrator

SYNOPSIS
    cman [COMMAND] [OPTIONS]

DESCRIPTION
    cman is a modern command-line build orchestrator for C projects, inspired
    by Cargo. It provides a unified interface for creating, building, testing,
    and managing C projects with sensible defaults and minimal configuration.

COMMANDS
    new [--test | --clean | --embedded] <n>
        Create a new C project with the specified name. Optional flags control
        the project template type.

    init [--test | --clean | --embedded]
        Initialize the current directory as a cman project. Useful for
        converting existing projects.

    build [--release]
        Compile the project. By default, builds in debug mode (-O0). Use
        --release for optimized builds (-O3).

    run [version]
        Run the compiled executable. Defaults to the project binary. If the
        binary doesn't exist, automatically builds it.

    test
        Discover and compile all test_*.c files in the tests/ directory,
        then execute the test runner.

    clean
        Remove all build artifacts (build/ and bin/ directories).

    format
        Run clang-format on all .c and .h files in the project.

    check
        Run clang-tidy static analysis on source files.

    config [view|set|get] [key] [value]
        View, set, or get configuration values from cman.toml.
        - config view      Display entire configuration
        - config set KEY VALUE
        - config get KEY   Print a specific value

    env
        Print environment information including detected compiler, OS,
        and current project configuration.

    package
        Bundle project for distribution (future).

    install
        Install built binary system-wide (future).

    update
        Update project dependencies (future).

    embed
        Cross-compile for embedded targets (future).

    bench
        Run performance benchmarks (future).

    version, -v, --version
        Print cman version.

    help, -h, --help
        Print brief usage information.

    man
        Display this manual page.

PROJECT STRUCTURE
    When you create or initialize a project, cman generates:

        project_name/
        ├── include/           Header files (.h)
        ├── src/               Source files (.c)
        ├── build/             Object files (.o) [generated]
        ├── bin/               Executables [generated]
        ├── tests/             Unit tests
        ├── cman.toml          Project configuration
        ├── Makefile           Build information
        ├── README.md          Documentation
        └── .gitignore         Git ignore rules

CONFIGURATION
    Projects are configured via cman.toml in TOML format:

        [project]
        name = "myapp"
        version = "0.1.0"
        type = "default"

        [build]
        compiler = "clang"
        src = "src"
        include = "include"
        build = "build"
        bin = "bin"
        cflags = "-Wall -Wextra -std=c11"
        ldflags = ""

        [dev]
        debug = true
        optimization = "0"

        [release]
        debug = false
        optimization = "3"

EXAMPLES
    Create a new project:
        $ cman new my_app
        $ cd my_app
        $ cman build
        $ cman run

    Create a test project:
        $ cman new --test my_tests

    Initialize existing directory:
        $ cd existing_project
        $ cman init

    Build in release mode:
        $ cman build --release

    Run tests:
        $ cman test

    Configure compiler:
        $ cman config set build_compiler gcc

ENVIRONMENT
    CMAN_HOME     Directory for cman metadata (default: .cman)
    PAGER         Pager for manual pages (default: less)

SUPPORT
    Bug reports and feature requests:
        https://github.com/jr-cho/cman/issues

    Documentation:
        https://github.com/jr-cho/cman

AUTHOR
    Maintained by jr-cho

VERSION
    cman 0.2.0

CMAN(1)                     C Project Manager                      CMAN(1)
MANEOF

    man "$tmp_man" 2>/dev/null || ${PAGER:-less} "$tmp_man"
    rm -f "$tmp_man"
}

cmd_version() {
    echo "cman $CMAN_VERSION"
}

################################################################################
# Main Command Dispatcher
################################################################################

main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        new)        cmd_new "$@" ;;
        init)       cmd_init "$@" ;;
        build)      cmd_build "$@" ;;
        run)        cmd_run "$@" ;;
        test)       cmd_test "$@" ;;
        clean)      cmd_clean "$@" ;;
        format)     cmd_format "$@" ;;
        check)      cmd_check "$@" ;;
        config)     cmd_config "$@" ;;
        env)        cmd_env "$@" ;;
        package)    cmd_package "$@" ;;
        install)    cmd_install "$@" ;;
        update)     cmd_update "$@" ;;
        embed)      cmd_embed "$@" ;;
        bench)      cmd_bench "$@" ;;
        help|-h|--help)
                    cmd_help ;;
        man)        cmd_man ;;
        version|-v|--version)
                    cmd_version ;;
        *)
            log_error "Unknown command: $command"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
